# 個別指導塾 授業スケジュール自動配置システム

## 概要

個別指導塾の授業スケジュールを**数理最適化**で自動作成するシステムです。

生徒の受講希望・講師の指導可能科目・双方の空き時間を入力すると、すべての制約条件（ハード制約）を守りながら**配置数を最大化**します。すべてのリクエストを完全に満たせない場合でも、可能な限り多くの授業を配置し、配置できなかった分は未配置リスト（`O02`）に出力します。

### 技術スタック

| コンポーネント | 技術 | 役割 |
|---|---|---|
| データ管理 | Google Spreadsheet | マスタデータ・入力・出力の一元管理 |
| 入力UI | Google Apps Script (GAS) | チェックボックス形式の空き入力画面を自動生成 |
| 最適化エンジン | Google Colab + OR-Tools (SCIP) | 整数線形計画法による最適配置計算 |
| 可視化 | GAS | 配置結果をスケジュール表として自動生成 |

---

## システム構成

```
autoScheduling/
├── scripts/
│   └── parse_pdfs.py          # PDF→CSV変換スクリプト（校舎データ作成）
├── colab/
│   ├── 01_setup.py            # Google認証・ライブラリ読み込み
│   ├── 02_dataInput.py        # データ読み込み・診断レポート
│   └── 03_optimization.py     # 最適化計算・結果出力
├── GAS/
│   └── gas.js                 # スプレッドシートのメニュー・入力UI・可視化
├── sample_sheet/              # サンプルデータ（CSV）
└── samplePdfs/                # 校舎別PDFデータ（gitignore対象）
    └── tamapura/
        ├── input/             # 元PDF（枠取表・講師カード）
        └── output/            # 生成済みCSV
```

---

## スプレッドシートのシート構成

### 入力シート（マスタデータ）

| シート名 | 説明 | 主なカラム |
|---|---|---|
| `I01_subject` | 科目マスタ | id, subject_name |
| `I02_time_range` | 時間帯の定義 | id, description（1限, 2限...） |
| `I03_student_list` | 生徒マスタ（＋個人別制約値） | id, student_name, max_continuous_slot, max_daily_slot |
| `I04_teacher_list` | 講師マスタ（＋個人別制約値） | id, teacher_name, max_daily_slot, max_continuous_vacant_slot |
| `I05_lesson_slot` | 授業枠（日付×時間帯） | id, date, time_range_id |
| `I06_teachable_subjects` | 講師が指導可能な科目 | teacher_id, subject_id |
| `I07_student_subject` | 生徒の受講希望 | student_id, subject_id, sessions, desired_teacher_1〜3, max_slot_1〜3 |

#### I07_student_subject — 受講希望と講師指定の詳細

このシートは「誰が・何を・何コマ・誰に教わりたいか」を定義する、スケジューリングの中核データです。

**カラム定義**:

| カラム | 説明 |
|---|---|
| `student_id` | 生徒ID |
| `subject_id` | 科目ID |
| `sessions` | 希望コマ数（この科目で合計何コマ受けたいか） |
| `desired_teacher_1` | 第1希望の講師ID（空欄 = 指定なし） |
| `max_slot_1` | 第1希望の講師に担当してもらう**最大コマ数**（空欄 = 上限なし） |
| `desired_teacher_2` | 第2希望の講師ID |
| `max_slot_2` | 第2希望の講師の最大コマ数 |
| `desired_teacher_3` | 第3希望の講師ID |
| `max_slot_3` | 第3希望の講師の最大コマ数 |

**講師指定の振り分けロジック**:

講師が指定されている場合、最適化エンジンは**指定された講師の中からのみ**配置先を選びます。さらに `max_slot` で講師ごとの担当コマ数に上限をかけることで、複数講師への振り分けを制御できます。

**例1: 1人の講師に全コマ任せる**

```
student_id=1, subject_id=1(数学), sessions=3
desired_teacher_1=1(吉田先生), max_slot_1=（空欄）
```

→ 吉田先生に数学3コマすべてを配置（max_slot未指定 = 上限なし）

**例2: 2人の講師に振り分ける（上限指定あり）**

```
student_id=1, subject_id=1(数学), sessions=3
desired_teacher_1=1(吉田先生), max_slot_1=2
desired_teacher_2=2(松本先生), max_slot_2=1
```

→ 吉田先生に**最大2コマ**、松本先生に**最大1コマ**。合計3コマをこの2人の中で配置。
→ 結果例: 吉田先生2コマ＋松本先生1コマ = 3コマ

**例3: メイン講師＋サブ講師（残りを任せる）**

```
student_id=3, subject_id=2(英語), sessions=3
desired_teacher_1=3(井上先生), max_slot_1=2
desired_teacher_2=5(林先生),   max_slot_2=1
```

→ 井上先生に**最大2コマ**、残り1コマを林先生に配置。
→ 「メインは井上先生だが、枠が足りない分は林先生に」という運用。

**例4: 講師指定なし（全講師対象）**

```
student_id=5, subject_id=1(数学), sessions=2
desired_teacher_1=（空欄）
```

→ 数学を教えられる講師（`I06_teachable_subjects` に登録されている講師）全員が候補。
→ 最適化エンジンが空き状況や他の制約を考慮して最適な講師を自動選択。

**例5: max_slot の合計が sessions より少ない場合**

```
student_id=4, subject_id=1(数学), sessions=3
desired_teacher_1=1(吉田先生), max_slot_1=1
desired_teacher_2=2(松本先生), max_slot_2=1
```

→ 吉田先生に最大1コマ、松本先生に最大1コマ = 最大でも合計2コマしか配置できない。
→ 残り1コマは**未配置**（`O02_output_unallocated_lessons` に出力される）。
→ **注意**: max_slot の合計 < sessions の場合、全コマ配置は不可能です。

**振り分けの判断フロー**:

```
1. desired_teacher_1〜3 が指定されているか？
   ├─ YES → 指定された講師のみが候補
   │         └─ 各講師に max_slot の上限を適用
   │            ├─ max_slot が空欄 → その講師への上限なし（= sessions と同じ）
   │            └─ max_slot が数値 → その講師は最大その数まで
   └─ NO  → その科目を教えられる全講師が候補（上限なし）

2. 候補講師の中から、空き時間・他の制約を考慮して最適配置
```

**追記配置モードでの動作**:

既に配置済みのコマがある場合、max_slot は**残り枠**として再計算されます。

```
例: max_slot_1=2 で既に吉田先生に1コマ配置済み
→ 追記計算では吉田先生の残り上限 = 2 - 1 = 1コマ
```

### 入力シート（空き情報）

| シート名 | 説明 | 主なカラム |
|---|---|---|
| `I51_student_availability` | 生徒の空き時間 | student_id, slot_id |
| `I52_teacher_availability` | 講師の空き時間 | teacher_id, slot_id |

### 制約条件シート

| シート名 | 説明 | 主なカラム |
|---|---|---|
| `constraint` | 制約のON/OFF制御 | code, description, activated, value |

### 出力シート

| シート名 | 説明 |
|---|---|
| `O01_output_allocated_lessons` | 配置結果（生徒×講師×科目×スロット） |
| `O02_output_unallocated_lessons` | 未配置リスト（配置できなかった授業と理由） |
| `Visualized_Schedule` | スケジュール表（GASで生成） |

### UI用シート（GASが自動生成）

| シート名 | 説明 |
|---|---|
| `UI_Student_Input` | 生徒の空き入力画面（チェックボックス） |
| `UI_Teacher_Input` | 講師の空き入力画面（チェックボックス） |

---

## 操作手順

### 1. マスタデータの準備

科目・時間帯・生徒・講師・授業枠・指導可能科目・受講希望をスプレッドシートに入力する。

### 2. 空き情報の入力（GAS メニュー）

スプレッドシートのメニュー「⚡ 自動配置ツール」から操作：

1. **「1. 生徒用：入力シートを作成」** → `UI_Student_Input` シートが生成される
2. 生徒の空き時間にチェックを入れる
3. **「2. 生徒用：データを保存」** → `I51_student_availability` に反映
4. **「3. 講師用：入力シートを作成」** → `UI_Teacher_Input` シートが生成される
5. 講師の空き時間にチェックを入れる
6. **「4. 講師用：データを保存」** → `I52_teacher_availability` に反映

### 3. 最適化の実行（Google Colab）

Colabのセルを順番に実行：

1. **セル1 (`01_setup.py`)**: Google認証
2. **セル2 (`02_dataInput.py`)**: データ読み込み＋診断レポート表示
3. **セル3 (`03_optimization.py`)**: 最適化計算 → 結果をスプレッドシートに書き込み

### 4. 結果の確認

- **スプレッドシート上**: `O01_output_allocated_lessons` で配置結果を確認
- **GAS メニュー「5. 結果をスケジュール表で表示」**: `Visualized_Schedule` で見やすい表形式で確認
- **未配置の確認**: `O02_output_unallocated_lessons` で配置できなかった授業を確認

### 5. リセット

- **GAS メニュー「6. 配置結果をリセット」**: O01, O02, Visualized_Schedule をクリア

---

## 制約条件の詳細

> 制約条件の詳細な説明（図解・パターン別具体例・解なし対処法など）は **[CONSTRAINTS.md](./CONSTRAINTS.md)** を参照してください。

最適化エンジンは**基本制約**と**追加制約**の2種類のハード制約を使います。すべての制約を守った上で、配置数（コマ数）を最大化する目的関数で計算します。

### 基本制約（常に有効・OFF不可）

これらは「物理的に不可能な配置」を防ぐためのルールです。

| 制約 | 内容 | 具体例 |
|---|---|---|
| 同時受講禁止 | 生徒は同じ時間帯に2つ以上の授業を受けられない | 田中くんが7/1の1限に数学と英語を同時に受けることはできない |
| 同時指導禁止 | 講師は同じ時間帯に2人以上の生徒を教えられない | 吉田先生が7/1の1限に田中くんと鈴木さんを同時に教えることはできない |
| コマ数上限 | 各リクエストの希望コマ数を超えて配置しない | 「数学3コマ」の希望に対して4コマ配置しない |
| 講師指定上限 | 講師ごとの最大担当コマ数を超えない | 「吉田先生は最大2コマまで」の指定を守る |

### 追加制約（ON/OFF切替可能）

`constraint` シートの `activated` 列で `TRUE` / `FALSE` を切り替えて制御します。

---

#### 制約1: `max_teacher_daily_slot` — 講師の1日あたりの授業数上限

**設定場所**: `I04_teacher_list` の `max_daily_slot` 列（講師ごとに設定）

**動作**: 各講師が1日に担当できる授業数の上限を定義します。

**具体例**:

| 講師 | max_daily_slot | 意味 |
|---|---|---|
| 吉田先生 | 4 | 1日最大4コマまで |
| 井上先生 | 3 | 1日最大3コマまで |

**影響**:
- **ON の場合**: 吉田先生は7/1に既に4コマ入っていれば、7/1にはそれ以上配置されない
- **OFF の場合**: 講師は空き時間がある限り1日に何コマでも配置される

---

#### 制約2: `max_student_continuous_slot` — 生徒の連続コマ上限

**設定場所**: `I03_student_list` の `max_continuous_slot` 列（生徒ごとに設定）

**動作**: 生徒が連続して受講できるコマ数の上限を定義します。「連続(N+1)コマの中にNコマまで」というスライディングウィンドウ方式でチェックします。

**具体例**:

| 生徒 | max_continuous_slot | 意味 |
|---|---|---|
| 田中太郎 | 2 | 連続3コマ中に2コマまで（＝3連続はNG） |
| 佐藤健一 | 3 | 連続4コマ中に3コマまで（＝4連続はNG） |

**影響**:
- **ON の場合**: 田中太郎くんが1限・2限に授業があれば、3限は空けて4限に配置される
- **OFF の場合**: 連続何コマでも配置される（1限〜4限すべて授業になりうる）

---

#### 制約3: `max_student_daily_slot` — 生徒の1日あたり上限コマ数

**設定場所**: `I03_student_list` の `max_daily_slot` 列（生徒ごとに設定）

**動作**: 生徒が1日に受けられる授業数の上限を定義します。

**具体例**:

| 生徒 | max_daily_slot | 意味 |
|---|---|---|
| 田中太郎 | 3 | 1日最大3コマまで |
| 渡辺結衣 | 4 | 1日最大4コマまで |

**影響**:
- **ON の場合**: 田中太郎くんは1日最大3コマ。残りの授業は別の日に配置される
- **OFF の場合**: 空きがある限り1日に何コマでも入る

---

#### 制約4: `max_lesson_per_timeslot` — 同一時限の上限コマ数（ブース上限）

**設定場所**: `constraint` シートの `value` 列（全体で1つの値）

**動作**: 同じ時間帯に同時に実施できる授業数の上限を定義します。教室のブース数やスペースの物理的制約を反映します。

**具体例**:

| value | 意味 |
|---|---|
| 3 | 同時に最大3組まで授業できる（ブースが3つ） |
| 5 | 同時に最大5組まで（ブースが5つ） |

**影響**:
- **ON (value=3) の場合**: 7/1の1限に既に3組の授業があれば、4組目は別の時間帯に配置される
- **OFF の場合**: 同時に何組でも授業できる（ブース制限なし）

---

#### 制約5: `max_teacher_continuous_vacant_slot` — 講師の空きコマ上限数

**設定場所**: `I04_teacher_list` の `max_continuous_vacant_slot` 列（講師ごとに設定）

**動作**: 講師の「最初の授業」と「最後の授業」の間にある空きコマ数の上限を定義します。授業と授業の間が空きすぎる非効率な配置を防ぎます。

**具体例**:

| 講師 | max_continuous_vacant_slot | 意味 |
|---|---|---|
| 吉田先生 | 1 | 授業間の空きは最大1コマまで |
| 木村先生 | 2 | 授業間の空きは最大2コマまで |

**図解** (1日4コマの場合):

```
吉田先生 (上限1):
  ✅ OK:  [授業][授業][空き][授業]  → 間の空き = 1コマ
  ❌ NG:  [授業][空き][空き][授業]  → 間の空き = 2コマ（上限超過）
  ✅ OK:  [空き][授業][授業][空き]  → 前後の空きはカウント外

木村先生 (上限2):
  ✅ OK:  [授業][空き][空き][授業]  → 間の空き = 2コマ
  ❌ NG:  [授業][空き][空き][空き]＋[授業]  → もし5限まであれば間の空き = 3コマ
```

**影響**:
- **ON の場合**: 講師の待ち時間が制限される。「1限と4限だけ授業」のような非効率な配置が防止される
- **OFF の場合**: 授業間にいくらでも空きコマが入りうる

---

## 配置の最大化と未配置

### 動作方針

このシステムは**すべての制約をハード制約**として扱い、制約を守った範囲で**配置数（コマ数）を最大化**します。

- すべてのリクエストが配置できれば → `O02` は空（ヘッダーのみ出力）
- 一部のリクエストが配置できなければ → 配置できなかった分が `O02_output_unallocated_lessons` に出力される
- 制約が厳しいほど配置可能数が減り、未配置が増えます

### 未配置が発生する主な原因

| 状況 | 原因 | 対処法 |
|---|---|---|
| 生徒の空きが少なすぎる | 希望3コマに対して空き2箇所しかない | 生徒の空き登録を増やす |
| ブース上限が厳しい | 全員が同じ時間帯を希望している | ブース数（value）を増やすか、空き時間を分散 |
| 講師の1日上限 + 空きコマ上限の競合 | 1日上限2コマ＋空き0コマ → 配置パターンが限られる | どちらかの上限を緩める |
| 指定講師の空きが足りない | 「吉田先生のみ」指定で吉田先生の空きが足りない | 講師指定を増やすか外す |
| max_slot の合計 < sessions | 講師上限の合計が希望コマ数に届かない | max_slot を増やすか講師を追加 |

### 解なし (INFEASIBLE) について

通常は「配置数0コマ」も有効な解として扱われるため、解なしにはなりません。ただし、追記配置モードで**既存の配置が制約5（講師の空きコマ上限）に違反している**場合など、ごくまれにINFEASIBLEになる可能性があります。その場合は診断レポートが出力されます。

### 制約の「緩める」方向の指針

未配置を減らしたい場合は、以下の順で制約を緩めるのがおすすめです：

1. **ブース上限を上げる** (影響: 施設コストのみ)
2. **講師の1日上限を上げる** (影響: 講師の負担)
3. **生徒の1日上限を上げる** (影響: 生徒の負担)
4. **講師の空きコマ上限を上げる** (影響: 講師の待ち時間)
5. **生徒の連続コマ上限を上げる** (影響: 生徒の集中力)

---

## 追記配置モード

このシステムは**追記配置**に対応しています。

- `O01_output_allocated_lessons` に既存の配置データがある状態で最適化を実行すると、**既存の配置は固定**したまま、残りの未配置分のみを計算します
- 「一部を手動で確定させてから、残りを自動配置」といった運用が可能です
- リセットしたい場合は GAS メニューの「6. 配置結果をリセット」を使ってください

---

## PDF→CSV変換（校舎データ作成）

実際の校舎で使われている枠取表・講師カードのPDFから、入力CSVを自動生成できます。

### 前提条件

- Python 3.11 + pdfplumber

### 実行方法

```bash
/usr/local/bin/python3.11 scripts/parse_pdfs.py samplePdfs/tamapura
```

- 入力: `samplePdfs/tamapura/input/` 内の `student.pdf`, `teacher.pdf`
- 出力: `samplePdfs/tamapura/output/` に I01〜I52, constraint.csv を生成

### 新しい校舎を追加する場合

1. `samplePdfs/<校舎名>/input/` に PDF を配置
2. 必要に応じて `scripts/parse_pdfs.py` の `PERIOD_START`, `PERIOD_END`, `TIME_SLOTS` 等を修正
3. `python3.11 scripts/parse_pdfs.py samplePdfs/<校舎名>` を実行

---

## サンプルデータの規模

| 項目 | 数量 |
|---|---|
| 科目 | 5（数学, 英語, 国語, 理科, 社会） |
| 時間帯 | 4（1限〜4限） |
| 日数 | 5日間（7/1〜7/5） |
| 授業枠 (スロット) | 20（5日 × 4限） |
| 生徒 | 8名 |
| 講師 | 5名 |
| 受講リクエスト | 17件（合計約34コマ） |
