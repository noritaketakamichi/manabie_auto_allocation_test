# 制約条件ガイド

授業スケジュール自動配置システムで使用される制約条件の詳細です。

**すべての制約はハード制約**です。制約を守った範囲で**配置数（コマ数）を最大化**します。全コマ配置できない場合は、未配置分が `O02_output_unallocated_lessons` に出力されます。

---

## 制約条件の全体像

制約は**基本制約**（常に有効）と**追加制約**（ON/OFF切替可能）の2層構造で、すべてハード制約です。

```
┌──────────────────────────────────────────────┐
│  基本制約（常に有効・OFF不可）                │
│  ・同時受講禁止（生徒は1スロット1授業）       │
│  ・同時指導禁止（講師は1スロット1授業）       │
│  ・コマ数上限（希望数以上は配置しない）       │
│  ・講師指定上限（講師別max_slotを守る）       │
├──────────────────────────────────────────────┤
│  追加制約（constraint シートで ON/OFF 制御）   │
│  1. 講師の1日あたり授業数上限    [個人別]     │
│  2. 生徒の連続コマ上限          [個人別]     │
│  3. 生徒の1日あたり上限コマ数    [個人別]     │
│  4. 同一時限の上限コマ数         [全体]       │
│  5. 講師の空きコマ上限数        [個人別]     │
└──────────────────────────────────────────────┘
```

### 設定値の管理場所

| 制約 | constraint シート | 値の定義場所 |
|---|---|---|
| 制約1 | `activated` のみ | `I04_teacher_list` の `max_daily_slot` 列 |
| 制約2 | `activated` のみ | `I03_student_list` の `max_continuous_slot` 列 |
| 制約3 | `activated` のみ | `I03_student_list` の `max_daily_slot` 列 |
| 制約4 | `activated` + `value` | constraint シートの `value` 列 |
| 制約5 | `activated` のみ | `I04_teacher_list` の `max_continuous_vacant_slot` 列 |

> 制約1,2,3,5 は**個人ごとに異なる値**を設定できます。constraint シートの `activated` で一括ON/OFFし、具体的な数値は各人のマスタシートで管理します。
> 制約4 のみ**全体で1つの値**を constraint シートの `value` 列に持ちます。

---

## 基本制約（常に有効）

最適化エンジンが常に適用するルールです。これらはOFFにできません。

### 同時受講禁止

> 1人の生徒は、同じ時間帯に2つ以上の授業を受けられない

```
7/1 1限:
  田中太郎 → 数学(吉田先生)   ← これが入っている場合
  田中太郎 → 英語(井上先生)   ← これは絶対に入らない
```

### 同時指導禁止

> 1人の講師は、同じ時間帯に2人以上の生徒を教えられない

```
7/1 1限:
  吉田先生 → 田中太郎(数学)   ← これが入っている場合
  吉田先生 → 鈴木花子(数学)   ← これは絶対に入らない
```

### コマ数上限

> 各リクエストの希望コマ数を超えて配置しない

```
田中太郎 数学 3コマ希望 → 最大3コマまで配置（4コマ以上は入らない）
```

### 講師指定上限（max_slot）

> `I07_student_subject` で講師ごとに指定された最大コマ数を超えない

```
田中太郎 数学 3コマ希望:
  desired_teacher_1 = 吉田先生, max_slot_1 = 2  → 吉田先生は最大2コマ
  desired_teacher_2 = 松本先生, max_slot_2 = 1  → 松本先生は最大1コマ
```

この仕組みの詳細は後述の「講師指定と max_slot の振り分けロジック」を参照してください。

---

## 追加制約1: 講師の1日あたりの授業数上限

| 項目 | 値 |
|---|---|
| constraint code | `max_teacher_daily_slot` |
| 設定場所 | `I04_teacher_list` → `max_daily_slot` 列 |
| 単位 | 講師ごと・1日あたり |

### 何を制御するか

各講師が**1日に担当できる授業の最大数**を制限します。

### サンプルデータでの設定値

| 講師 | max_daily_slot |
|---|---|
| 吉田先生 | 4 |
| 松本先生 | 4 |
| 井上先生 | 3 |
| 木村先生 | 4 |
| 林先生 | 3 |

### ON/OFF による配置の違い

**1日4コマ（1限〜4限）の場合:**

```
【ON: 井上先生 max_daily_slot = 3】

  7/1: [授業][授業][授業][----]  ← 3コマで打ち止め。4限には入らない
  7/2: [授業][----][----][----]  ← 7/1に入らなかった分が別日に回る

【OFF】

  7/1: [授業][授業][授業][授業]  ← 4コマ全部入りうる
  7/2: [----][----][----][----]  ← 7/1で消化しきれば7/2は空き
```

### 既存配置がある場合の動作

追記配置モードでは、既に配置済みのコマ数を差し引いて残り枠を計算します。

```
井上先生 max_daily_slot = 3, 7/1に既に2コマ配置済み
→ 7/1の追加配置可能数 = 3 - 2 = 1コマ
```

---

## 追加制約2: 生徒の連続コマ上限

| 項目 | 値 |
|---|---|
| constraint code | `max_student_continuous_slot` |
| 設定場所 | `I03_student_list` → `max_continuous_slot` 列 |
| 単位 | 生徒ごと・1日の中での連続判定 |

### 何を制御するか

生徒が**休憩なしで連続して受けられる最大コマ数**を制限します。

### 判定方法（スライディングウィンドウ）

`max_continuous_slot = N` の場合、**連続する (N+1) コマの中に授業は N コマまで**というルールを、1日の全時間帯にスライドさせてチェックします。

```
max_continuous_slot = 2 の場合:

チェック窓(3コマ幅)をスライドさせる:
  窓1: [1限][2限][3限] → この中に授業は2コマまで
  窓2: [2限][3限][4限] → この中に授業は2コマまで
```

### サンプルデータでの設定値

| 生徒 | max_continuous_slot | 意味 |
|---|---|---|
| 田中太郎 | 2 | 3連続NG（2連続までOK） |
| 鈴木花子 | 2 | 3連続NG |
| 佐藤健一 | 3 | 4連続NG（3連続までOK） |

### ON/OFF による配置の違い

```
【ON: 田中太郎 max_continuous_slot = 2】

  ✅ OK:  [数学][英語][----][理科]  ← 2連続 + 休憩 + 1コマ
  ✅ OK:  [----][数学][英語][----]  ← 2連続のみ
  ❌ NG:  [数学][英語][理科][----]  ← 3連続（窓1で3コマ検出 > 上限2）

【OFF】

  ✅ OK:  [数学][英語][理科][社会]  ← 4連続でもOK
```

### 制約2 と 制約3 の関係

| 設定 | 制約2 (連続上限) | 制約3 (1日上限) | 結果 |
|---|---|---|---|
| 連続2, 1日3 | 3連続NG | 1日3コマまで | `[授業][授業][--][授業]` のような配置 |
| 連続2, 1日4 | 3連続NG | 1日4コマまで | `[授業][授業][--][授業]` で3コマ止まり（4コマ目を入れるスロットがない） |
| 連続3, 1日3 | 4連続NG | 1日3コマまで | `[授業][授業][授業][--]` で3コマ |

> 制約2と制約3を両方ONにすると、より厳しい方が実質的な制約になります。

---

## 追加制約3: 生徒の1日あたり上限コマ数

| 項目 | 値 |
|---|---|
| constraint code | `max_student_daily_slot` |
| 設定場所 | `I03_student_list` → `max_daily_slot` 列 |
| 単位 | 生徒ごと・1日あたり |

### 何を制御するか

生徒が**1日に受けられる授業の最大数**を制限します。

### サンプルデータでの設定値

| 生徒 | max_daily_slot |
|---|---|
| 田中太郎 | 3 |
| 鈴木花子 | 3 |
| 佐藤健一 | 4 |
| 渡辺結衣 | 4 |

### ON/OFF による配置の違い

```
【ON: 田中太郎 max_daily_slot = 3, 合計5コマ希望】

  7/1: [数学][英語][理科][----]  ← 3コマで打ち止め
  7/2: [数学][英語][----][----]  ← 残り2コマが翌日に

【OFF: 田中太郎 合計5コマ希望】

  7/1: [数学][英語][理科][数学]  ← 4コマ入りうる
  7/2: [英語][----][----][----]  ← 残り1コマ
```

### 既存配置がある場合の動作

```
田中太郎 max_daily_slot = 3, 7/1に既に2コマ配置済み
→ 7/1の追加配置可能数 = 3 - 2 = 1コマ
```

---

## 追加制約4: 同一時限の上限コマ数（ブース上限）

| 項目 | 値 |
|---|---|
| constraint code | `max_lesson_per_timeslot` |
| 設定場所 | `constraint` シート → `value` 列 |
| 単位 | 全体・スロットあたり |

### 何を制御するか

**同じ時間帯に同時に行える授業数の上限**を定義します。教室のブース数（物理的な座席数）を反映します。

> これだけが「全体で1つの値」を持つ制約です。他の制約はすべて個人別です。

### ON/OFF による配置の違い

```
【ON: value = 3（ブース3つ）】

  7/1 1限:
    ブース1: 田中太郎 - 数学(吉田先生)
    ブース2: 鈴木花子 - 英語(井上先生)
    ブース3: 佐藤健一 - 理科(木村先生)
    -------- ここが上限。4組目は入らない --------
    高橋美咲 - 国語 → 7/1 2限以降に回される

【OFF（ブース制限なし）】

  7/1 1限:
    田中太郎 - 数学(吉田先生)
    鈴木花子 - 英語(井上先生)
    佐藤健一 - 理科(木村先生)
    高橋美咲 - 国語(林先生)     ← 4組目もOK
    伊藤翔太 - 数学(松本先生)   ← 何組でもOK
```

### 未配置が発生するケース

ブース上限が厳しく、全スロットが埋まってしまうと未配置が発生します。

```
条件: 5日 × 4限 = 20スロット, ブース3 → 最大 60コマ配置可能
希望合計: 34コマ → 60 > 34 なので理論上は足りる

しかし全員が同じ日・同じ時間帯に空きを集中させると:
  実質的な配置可能数が減り、未配置が発生する可能性がある
```

---

## 追加制約5: 講師の空きコマ上限数

| 項目 | 値 |
|---|---|
| constraint code | `max_teacher_continuous_vacant_slot` |
| 設定場所 | `I04_teacher_list` → `max_continuous_vacant_slot` 列 |
| 単位 | 講師ごと・1日の中での判定 |

### 何を制御するか

1日の中で、講師の**授業と授業の間にある空きコマ数**を制限します。「1限に授業して、4限にまた授業」のような、間が空きすぎて非効率な配置を防ぎます。

### カウント方法

**その日の最初の授業〜最後の授業の間**にある空きコマのみをカウントします。最初の授業より前、最後の授業より後の空きは対象外です。

```
[空き][授業][空き][空き][授業][空き]
      ↑                  ↑
      最初の授業          最後の授業
            └─ 2コマ空き ─┘  ← この2コマが対象

最初より前の空き(1コマ)と最後より後の空き(1コマ)はカウントしない
```

### サンプルデータでの設定値

| 講師 | max_continuous_vacant_slot |
|---|---|
| 吉田先生 | 1 |
| 松本先生 | 1 |
| 井上先生 | 1 |
| 木村先生 | 2 |
| 林先生 | 1 |

### ON/OFF による配置の違い

```
【ON: 吉田先生 max_continuous_vacant_slot = 1】

  ✅ OK:  [授業][授業][----][----]  ← 連続配置。後の空きはカウント外
  ✅ OK:  [授業][----][授業][----]  ← 間の空き = 1コマ（上限内）
  ✅ OK:  [----][授業][授業][----]  ← 前後の空きはカウント外
  ❌ NG:  [授業][----][----][授業]  ← 間の空き = 2コマ（上限超過！）
  ✅ OK:  [----][----][----][授業]  ← 授業1コマのみ → 間なし

【ON: 木村先生 max_continuous_vacant_slot = 2】

  ✅ OK:  [授業][----][----][授業]  ← 間の空き = 2コマ（上限内）
  ❌ NG:  1限に授業、5限に授業（5限目がある場合）← 間の空き = 3コマ

【OFF】

  ✅ OK:  [授業][----][----][授業]  ← 間がいくら空いてもOK
```

### 追記配置時の注意点（既存配置との関係）

追記配置モードでは、既存配置が制約5に違反している場合でも、最適化エンジンは**その既存配置を変更しません**。間を埋められる候補スロットがある場合は埋めようとしますが、候補がない場合は警告を出してスキップします。

```
例: 吉田先生 max_continuous_vacant_slot = 1
  既存配置: [授業][----][----][授業]  ← 間の空き = 2コマ（既に違反）

  → 間に埋められる候補があれば埋めようとする
  → 候補がなければ、この制約はスキップし警告を表示
```

### 制約1 と 制約5 の相互作用

この2つを組み合わせると、講師の配置パターンが強く制限されます。

```
吉田先生: max_daily_slot = 3, max_continuous_vacant_slot = 1
1日4コマ（1限〜4限）の場合:

  可能な配置パターン:
  ✅ [授業][授業][授業][----]  ← 3連続
  ✅ [----][授業][授業][授業]  ← 3連続
  ✅ [授業][授業][----][授業]  ← 2コマ + 空き1 + 1コマ
  ✅ [授業][----][授業][授業]  ← 1コマ + 空き1 + 2コマ

  不可能な配置パターン:
  ❌ [授業][----][----][授業]  ← 空き2コマ（制約5違反）
  ❌ [授業][授業][授業][授業]  ← 4コマ（制約1違反: 上限3）
```

> 制約1の上限が小さく、制約5の上限も小さいと、講師の配置パターンが非常に限定され、解なし(INFEASIBLE)になりやすくなります。

---

## 講師指定と max_slot の振り分けロジック

`I07_student_subject` の講師指定は、追加制約とは別に**基本制約の一部**として常に動作します。

### カラム構成

```
student_id | subject_id | sessions | desired_teacher_1 | max_slot_1 | desired_teacher_2 | max_slot_2 | desired_teacher_3 | max_slot_3
```

### 判断フロー

```
desired_teacher が1つ以上指定されている？
├─ YES → 指定された講師のみが配置候補になる
│         各講師に max_slot の上限を適用:
│           ├─ max_slot が空欄 → 上限なし（sessions と同じ）
│           └─ max_slot が数値 → その講師は最大その数まで
│
└─ NO（全部空欄） → その科目を教えられる全講師が候補（I06_teachable_subjects 参照）
                     上限なし
```

### パターン別の具体例

#### パターンA: 1人の講師に全コマ任せる

```
田中太郎, 数学, 3コマ
  desired_teacher_1 = 吉田先生, max_slot_1 = （空欄）
```

| 講師 | 候補？ | 上限 |
|---|---|---|
| 吉田先生 | YES | 3（= sessions） |
| 他の講師 | NO | - |

→ 吉田先生が全3コマ担当

#### パターンB: 2人に明確に振り分ける

```
田中太郎, 数学, 3コマ
  desired_teacher_1 = 吉田先生, max_slot_1 = 2
  desired_teacher_2 = 松本先生, max_slot_2 = 1
```

| 講師 | 候補？ | 上限 |
|---|---|---|
| 吉田先生 | YES | 2 |
| 松本先生 | YES | 1 |
| 他の講師 | NO | - |

→ 吉田先生2コマ + 松本先生1コマ = 合計3コマ

#### パターンC: メイン講師 + max_slot なしの補助講師

```
佐藤健一, 英語, 3コマ
  desired_teacher_1 = 井上先生, max_slot_1 = 2
  desired_teacher_2 = 林先生,   max_slot_2 = （空欄）
```

| 講師 | 候補？ | 上限 |
|---|---|---|
| 井上先生 | YES | 2 |
| 林先生 | YES | 3（= sessions） |
| 他の講師 | NO | - |

→ 井上先生は最大2コマ、林先生は最大3コマ。合計 sessions=3 の範囲内で最適化
→ 結果例: 井上先生2コマ + 林先生1コマ

#### パターンD: 講師指定なし（自動選択）

```
伊藤翔太, 数学, 2コマ
  desired_teacher_1 = （空欄）
```

| 講師 | 候補？ | 条件 |
|---|---|---|
| 吉田先生 | YES（数学を教えられる） | 上限なし |
| 松本先生 | YES（数学を教えられる） | 上限なし |
| 井上先生 | NO（数学を教えられない） | - |
| 木村先生 | NO（数学を教えられない） | - |
| 林先生 | NO（数学を教えられない） | - |

→ 吉田先生と松本先生の中から、空き状況と他の制約を考慮して自動配置

#### パターンE: max_slot の合計が sessions に足りない（注意）

```
高橋美咲, 数学, 3コマ
  desired_teacher_1 = 吉田先生, max_slot_1 = 1
  desired_teacher_2 = 松本先生, max_slot_2 = 1
```

| 講師 | 候補？ | 上限 |
|---|---|---|
| 吉田先生 | YES | 1 |
| 松本先生 | YES | 1 |

→ 最大でも 1 + 1 = **2コマしか配置できない**
→ 残り1コマは未配置（`O02_output_unallocated_lessons` に出力）

> max_slot の合計が sessions を下回ると、全コマ配置が物理的に不可能になります。

### 追記配置モードでの再計算

既に配置済みのコマがある場合、各講師の max_slot は残り枠として再計算されます。

```
田中太郎 数学 3コマ:
  desired_teacher_1 = 吉田先生, max_slot_1 = 2

  1回目の計算: 吉田先生に1コマ配置
  2回目の計算（追記モード）:
    既に吉田先生に1コマ配置済み
    → 吉田先生の残り上限 = 2 - 1 = 1コマ
```

---

## 配置の最大化と制約の影響

### 動作方針

すべての制約は**ハード制約**として扱われます。制約を1つも緩和しません。その上で、目的関数が**配置数（コマ数）を最大化**します。

- 制約を守った範囲で最大限多くの授業が配置される
- すべて配置できれば → `O02` は空
- 一部配置できなければ → 配置できなかった分が `O02_output_unallocated_lessons` に出力される
- 制約が厳しいほど配置可能数が減り、未配置が増える

### 未配置が増える制約の組み合わせ

| 組み合わせ | なぜ厳しいか | 例 |
|---|---|---|
| 制約1 + 制約5 | 講師の1日上限が少なく、空きコマも許容しないと、配置できるパターンが極端に限られる | 1日上限2 + 空き上限0 → 2コマが連続する場所にしか配置できない |
| 制約2 + 制約3 | 連続制限と1日上限の両方があると、1日に入れられるコマ数が実質的にさらに減る | 連続上限1 + 1日上限3 → 1コマおきに入れると4限中2コマしか入らない |
| 制約4 + 少ない空き | ブース上限で同時授業数が制限されるのに、特定時間帯に空きが集中していると枠が足りなくなる | ブース2 + 全員が1限だけ空き → 1限に2コマしか入らない |
| 講師指定 + 少ない空き | 特定講師に指名が集中しているのに、その講師の空きが少ない | 全員が吉田先生指名 + 吉田先生の空き5コマ + 希望合計10コマ |

### 未配置を減らすための調整

未配置が多い場合は、影響の小さいものから順に制約を緩めます：

| 順位 | 操作 | 影響 |
|---|---|---|
| 1 | 制約4: ブース上限を上げる | 施設側の問題（物理的に可能なら） |
| 2 | 制約1: 講師1日上限を上げる | 講師の1日あたりの負担が増える |
| 3 | 制約3: 生徒1日上限を上げる | 生徒の1日あたりの負担が増える |
| 4 | 制約5: 講師空きコマ上限を上げる | 講師の待ち時間が増える |
| 5 | 制約2: 生徒連続上限を上げる | 生徒が休憩なしで連続受講する |
| - | 制約を OFF にする | その制約が完全に無効化される |

### どの制約が未配置の原因か特定する方法

制約を1つずつOFFにして再実行し、未配置の変化を見るのが効果的です。

```
手順:
1. 全制約 ON で実行 → 未配置 5件
2. 制約5 だけ OFF → 未配置 5件 → 制約5は影響していない
3. 制約1 だけ OFF → 未配置 1件 → 制約1が主な原因
4. 制約1 の値を調整（上限を +1） → 再実行して未配置が減るか確認
```

### 解なし (INFEASIBLE) について

通常は「配置数0コマ」も有効な解のため、INFEASIBLE にはなりません。ただし、ごくまれに以下のケースで発生する可能性があります：

- **追記配置モード**で、既存の配置データが制約5（講師の空きコマ上限）に違反しており、間を埋める候補もない場合

INFEASIBLE 発生時は以下のデバッグ情報が自動出力されます：

1. **リクエスト別の配置可能性分析** — 各リクエストの候補スロット数・候補講師数
2. **リソース利用状況** — 講師ごとの候補変数数・候補スロット数・既存コマ数
3. **有効な追加制約の一覧**
4. **対処法の提案**
